"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[985],{5816:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var s=t(4848),r=t(8453);const i={sidebar_position:4,title:"Liveness and Readiness Probes"},a=void 0,o={id:"kubernetes-basics/kubernetes-advanced/liveness-readiness-probes",title:"Liveness and Readiness Probes",description:"Source code: k8s-getting-started GitHub Repository",source:"@site/docs/kubernetes-basics/kubernetes-advanced/liveness-readiness-probes.md",sourceDirName:"kubernetes-basics/kubernetes-advanced",slug:"/kubernetes-basics/kubernetes-advanced/liveness-readiness-probes",permalink:"/hands-on-containers/kubernetes-basics/kubernetes-advanced/liveness-readiness-probes",draft:!1,unlisted:!1,editUrl:"https://github.com/armagankaratosun/hands-on-containers/tree/main/packages/create-docusaurus/templates/shared/docs/kubernetes-basics/kubernetes-advanced/liveness-readiness-probes.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,title:"Liveness and Readiness Probes"},sidebar:"tutorialSidebar",previous:{title:"Exposing Services via Ingress",permalink:"/hands-on-containers/kubernetes-basics/kubernetes-advanced/service-ingress"},next:{title:"Helm Basics",permalink:"/hands-on-containers/category/helm-basics"}},d={},l=[{value:"Create a ClusterIP Service",id:"create-a-clusterip-service",level:2},{value:"Example Output",id:"example-output",level:3},{value:"Create an Ingress to Expose your ClusterIP service",id:"create-an-ingress-to-expose-your-clusterip-service",level:2},{value:"Example Output",id:"example-output-1",level:3},{value:"Browser Output",id:"browser-output",level:4},{value:"Deploy the application",id:"deploy-the-application",level:2},{value:"Example Output",id:"example-output-2",level:3},{value:"Browser Output",id:"browser-output-1",level:4},{value:"Wait Until the Liveness and Readiness Probes Succeed",id:"wait-until-the-liveness-and-readiness-probes-succeed",level:3},{value:"Browser Output",id:"browser-output-2",level:4},{value:"Bonus Points",id:"bonus-points",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Source code: ",(0,s.jsx)(n.a,{href:"https://github.com/armagankaratosun/k8s-getting-started",children:"k8s-getting-started GitHub Repository"})]}),"\n",(0,s.jsx)(n.p,{children:"You can copy/paste the YAML manifests from this guide, or clone the repository to edit and use the manifests directly."}),"\n",(0,s.jsxs)(n.p,{children:["For this example, we will first create the ",(0,s.jsx)(n.code,{children:"ClusterIP"})," service to have internal serivce ready to forward requests to pods."]}),"\n",(0,s.jsx)(n.h2,{id:"create-a-clusterip-service",children:"Create a ClusterIP Service"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: k8s-getting-started-with-probes-service\nspec:\n  type: ClusterIP                       # Internal-only access within the cluster\n  selector:\n    app: k8s-getting-started-with-probes     # Matches the label of the Deployment\n  ports:\n    - protocol: TCP\n      port: 8080                           # Port exposed by the service\n      targetPort: 8080                   # Port on the container that the app is running on\n"})}),"\n",(0,s.jsx)(n.h3,{id:"example-output",children:"Example Output"}),"\n",(0,s.jsxs)(n.p,{children:["Check the ",(0,s.jsx)(n.code,{children:"k8s-getting-started-with-probes-service "})," service."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"armagan@ ~ $ kubectl get svc\nNAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)        AGE\nk8s-getting-started-with-probes-service   ClusterIP      10.67.244.249   <none>            8080/TCP       119m\n"})}),"\n",(0,s.jsx)(n.h2,{id:"create-an-ingress-to-expose-your-clusterip-service",children:"Create an Ingress to Expose your ClusterIP service"}),"\n",(0,s.jsxs)(n.p,{children:["Now we need an ingress manifest to expose ",(0,s.jsx)(n.code,{children:"k8s-getting-started-with-probes"})," service to the outside world. Please pay attention to ",(0,s.jsx)(n.code,{children:"backend.service"})," to match with the ",(0,s.jsx)(n.code,{children:"ClusterIP"})," service."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: k8s-getting-started-ingress-probes\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /  # Ensures paths are properly routed to the service\nspec:\n  rules:\n  - host: "<yourname>.<yourdomain>.com"  # Replace <yourname>.<yourdomain>.com with your specific domain\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: k8s-getting-started-with-probes-service  # The name of the ClusterIP service for your app\n            port:\n              number: 8080  # Port of the service as defined in the service.yaml file\n'})}),"\n",(0,s.jsx)(n.h3,{id:"example-output-1",children:"Example Output"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"armagan@ ~ $ kubectl apply -f ingress.yaml\ningress.networking.k8s.io/k8s-getting-started-ingress-probes created\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'armagan@ ~ $ kubectl get ingress\nNAME                          CLASS   HOSTS                                                        ADDRESS                                               PORTS   AGE\nk8s-getting-started-ingress-probes   nginx   "<yourname>.<yourdomain>.com"   10.0.0.1,10.0.0.2,10.0.0.3,10.0.0.4,10.0.0.5   80      77s\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Now you can try to access the service from the ",(0,s.jsx)(n.code,{children:"HOST: <yourname>.<yourdomain>.com"})]}),"\n",(0,s.jsx)(n.h4,{id:"browser-output",children:"Browser Output"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"alt text",src:t(9093).A+"",width:"1283",height:"151"})}),"\n",(0,s.jsx)(n.p,{children:"This output is expected, since we did not deploy the application yet."}),"\n",(0,s.jsx)(n.h2,{id:"deploy-the-application",children:"Deploy the application"}),"\n",(0,s.jsxs)(n.p,{children:["Below are the YAML manifests for a Kubernetes Deployment using a demo application, implementing healtchecks under ",(0,s.jsx)(n.code,{children:"/healthz"}),". (Located at ",(0,s.jsx)(n.code,{children:"Deployments/deployment-probes.yaml"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: k8s-getting-started-with-probes\n  labels:\n    app: k8s-getting-started-with-probes\nspec:\n  replicas: 2\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 0\n      maxSurge: 1\n  selector:\n    matchLabels:\n      app: k8s-getting-started-with-probes\n  template:\n    metadata:\n      labels:\n        app: k8s-getting-started-with-probes\n    spec:\n      containers:\n        - name: k8s-getting-started-with-probes\n          image: armagankaratosun/k8s-getting-started:v4\n          imagePullPolicy: Always\n          ports:\n            - containerPort: 8080\n          livenessProbe:\n            httpGet:\n              path: /   \n              port: 8080\n            successThreshold: 1 \n            failureThreshold: 3\n          readinessProbe:\n            httpGet:\n              path: /healthz   # Readiness check on the /healthz endpoint\n              port: 8080\n            successThreshold: 1 \n            failureThreshold: 3\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Here , The ",(0,s.jsx)(n.code,{children:"Liveness Probe "}),"checks if your application is still running. If this check fails several times, Kubernetes will restart the container to try to fix the problem."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"httpGet:"})," This specifies that Kubernetes should use an HTTP GET request to check the liveness of the container."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"path: /:"})," This is the URL path that Kubernetes will access on the container's IP address and specified port."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"port: 8080:"})," This is the container port on which the probe request will be sent."]}),"\n",(0,s.jsx)(n.li,{children:"successThreshold: 1: This means the probe needs to succeed only once to be considered successful. Once this probe succeeds, the container is considered healthy."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"failureThreshold: 3:"})," This is the number of times Kubernetes will try the liveness probe before giving up. After three consecutive failures, Kubernetes decides the container is not alive, and it needs to be restarted."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"Readiness Probe"}),' determines if your application is ready to handle requests. If this check fails, Kubernetes stops sending traffic to the pod until it passes the probe, ensuring that only "ready" pods receive traffic.']}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"httpGet:"})," This specifies the method of the health check, similar to the liveness probe."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"path: /healthz:"})," This path is specifically set to ",(0,s.jsx)(n.code,{children:"/healthz"})," for readiness check."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"port: 8080:"})," The port where the HTTP GET request is sent, which is the same as the liveness probe."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"successThreshold:"})," 1: This indicates that the probe needs to succeed only once to change the pod's status to ready."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"failureThreshold: 3:"})," This defines the number of consecutive failures that must occur for the readiness probe to consider the container not ready. Kubernetes will try the readiness probe three times, and if all attempts fail, the pod is marked as not ready and there will be no traffic forwarded to the pod."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"example-output-2",children:"Example Output"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"armagan@ ~ $ kubectl apply -f probes.yaml\ndeployment.apps/k8s-getting-started-with-probes created\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Now you can see the pods are ",(0,s.jsx)(n.code,{children:"STATUS"}),": ",(0,s.jsx)(n.code,{children:"Running"})," but they are not ",(0,s.jsx)(n.code,{children:"READY"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"armagan@ ~ $ kubectl get pods\nNAME                                               READY   STATUS    RESTARTS   AGE\nk8s-getting-started-with-probes-6f7f76b47b-fg6qj   0/1     Running   0          18s\nk8s-getting-started-with-probes-6f7f76b47b-zp6kc   0/1     Running   0          18s\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can confirm this (and also figure out what went wrong) with ",(0,s.jsx)(n.code,{children:"kubectl describe pod"})," command."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'armagan@darwin ~ $ kubectl describe pod k8s-getting-started-with-probes-6f7f76b47b-zp6kc\nName:             k8s-getting-started-with-probes-6f7f76b47b-zp6kc\nNamespace:        k8s-training-25\nPriority:         0\nService Account:  default\n...\n\nContainers:\n  k8s-getting-started-with-probes:\n    Container ID:   containerd://ebe38c56a1de54eaf1288b328da82bca3a66dbd896abc04774688079fbf92dd7\n    Image:          armagankaratosun/k8s-getting-started:v4\n    Image ID:       docker.io/armagankaratosun/k8s-getting-started@sha256:0b3993ffe6b8ff5fe689583e3da1c8143dbe920eddb893f563aac58ee50fda7c\n    Port:           8080/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Thu, 28 Nov 2024 04:08:51 +0100\n    Ready:          False\n    Restart Count:  0\n    Liveness:       http-get http://:8080/ delay=0s timeout=1s period=10s #success=1 #failure=3\n    Readiness:      http-get http://:8080/healthz delay=0s timeout=1s period=10s #success=1 #failure=3\n    Environment:    <none>\n...\nConditions:\n  Type                        Status\n  PodReadyToStartContainers   True\n  Initialized                 True\n  Ready                       False\n  ContainersReady             False\n  PodScheduled                True\n...\nEvents:\n  Type     Reason     Age               From               Message\n  ----     ------     ----              ----               -------\n  Normal   Scheduled  19s               default-scheduler  Successfully assigned k8s-training-25/k8s-getting-started-with-probes-6f7f76b47b-zp6kc to k8s-training-generic-worker-pool-mcvxl-wtfkw.datacoord.ewc\n  Normal   Pulling    18s               kubelet            Pulling image "armagankaratosun/k8s-getting-started:v4"\n  Normal   Pulled     17s               kubelet            Successfully pulled image "armagankaratosun/k8s-getting-started:v4" in 1.092s (1.092s including waiting). Image size: 52293103 bytes.\n  Normal   Created    17s               kubelet            Created container k8s-getting-started-with-probes\n  Normal   Started    16s               kubelet            Started container k8s-getting-started-with-probes\n  Warning  Unhealthy  16s               kubelet            Readiness probe failed: Get "http://10.66.250.145:8080/healthz": dial tcp 10.66.250.145:8080: connect: connection refused\n  Warning  Unhealthy  9s (x3 over 15s)  kubelet            Readiness probe failed: HTTP probe failed with statuscode: 503\n  Warning  Unhealthy  9s                kubelet            Liveness probe failed: HTTP probe failed with statuscode: 503\n'})}),"\n",(0,s.jsxs)(n.p,{children:["You can check ",(0,s.jsx)(n.code,{children:"Events"}),", ",(0,s.jsx)(n.code,{children:"Conditions"})," and ",(0,s.jsx)(n.code,{children:"Containers.Ready"})," and ",(0,s.jsx)(n.code,{children:"Containers.Restart Count"})," to see both ",(0,s.jsx)(n.code,{children:"Readiness"})," and ",(0,s.jsx)(n.code,{children:"Liveness"})," probes are failing."]}),"\n",(0,s.jsx)(n.h4,{id:"browser-output-1",children:"Browser Output"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"alt text",src:t(9093).A+"",width:"1283",height:"151"})}),"\n",(0,s.jsx)(n.h3,{id:"wait-until-the-liveness-and-readiness-probes-succeed",children:"Wait Until the Liveness and Readiness Probes Succeed"}),"\n",(0,s.jsxs)(n.p,{children:["Now, simply keep an eye on the pods. After the initialization phase, the pods should reach a ",(0,s.jsx)(n.code,{children:"READY"})," status."]}),"\n",(0,s.jsxs)(n.admonition,{type:"warning",children:[(0,s.jsxs)(n.p,{children:["However, this might not be the case for all pods! Pods can get stuck in a  ",(0,s.jsx)(n.code,{children:"STATUS:CrashLoopBackoff"})," if there are issues with:"]}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"The pod itself,"}),"\n",(0,s.jsx)(n.li,{children:"The liveness probe,"}),"\n",(0,s.jsx)(n.li,{children:"Or both."}),"\n"]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"armagan@ ~ $ kubectl get pods\nNAME                                               READY   STATUS    RESTARTS   AGE\nk8s-getting-started-with-probes-6f7f76b47b-fg6qj   1/1     Running   0          5m58s\nk8s-getting-started-with-probes-6f7f76b47b-zp6kc   1/1     Running   0          5m58s\n"})}),"\n",(0,s.jsxs)(n.p,{children:["and now ",(0,s.jsx)(n.code,{children:"Conditions"})," and ",(0,s.jsx)(n.code,{children:"Containers.Ready"})," should be the either ",(0,s.jsx)(n.code,{children:"True"})," or ",(0,s.jsx)(n.code,{children:"Running"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'armagan@darwin ~ $ kubectl describe pod k8s-getting-started-with-probes-6f7f76b47b-zp6kc\nName:             k8s-getting-started-with-probes-6f7f76b47b-zp6kc\nNamespace:        k8s-training-25\nPriority:         0\n...\nContainers:\n  k8s-getting-started-with-probes:\n    Container ID:   containerd://ebe38c56a1de54eaf1288b328da82bca3a66dbd896abc04774688079fbf92dd7\n    Image:          armagankaratosun/k8s-getting-started:v4\n    Image ID:       docker.io/armagankaratosun/k8s-getting-started@sha256:0b3993ffe6b8ff5fe689583e3da1c8143dbe920eddb893f563aac58ee50fda7c\n    Port:           8080/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Thu, 28 Nov 2024 04:08:51 +0100\n    Ready:          True\n    Restart Count:  0\n    Liveness:       http-get http://:8080/ delay=0s timeout=1s period=10s #success=1 #failure=3\n    Readiness:      http-get http://:8080/healthz delay=0s timeout=1s period=10s #success=1 #failure=3\n    Environment:    <none>\n...\nConditions:\n  Type                        Status\n  PodReadyToStartContainers   True\n  Initialized                 True\n  Ready                       True\n  ContainersReady             True\n  PodScheduled                True\n...\nEvents:\n  Type     Reason     Age                From               Message\n  ----     ------     ----               ----               -------\n  Normal   Scheduled  10m                default-scheduler  Successfully assigned k8s-training-25/k8s-getting-started-with-probes-6f7f76b47b-zp6kc to k8s-training-generic-worker-pool-mcvxl-wtfkw.datacoord.ewc\n  Normal   Pulling    10m                kubelet            Pulling image "armagankaratosun/k8s-getting-started:v4"\n  Normal   Pulled     10m                kubelet            Successfully pulled image "armagankaratosun/k8s-getting-started:v4" in 1.092s (1.092s including waiting). Image size: 52293103 bytes.\n  Normal   Created    10m                kubelet            Created container k8s-getting-started-with-probes\n  Normal   Started    10m                kubelet            Started container k8s-getting-started-with-probes\n  Warning  Unhealthy  10m                kubelet            Readiness probe failed: Get "http://10.66.250.145:8080/healthz": dial tcp 10.66.250.145:8080: connect: connection refused\n  Warning  Unhealthy  10m (x3 over 10m)  kubelet            Readiness probe failed: HTTP probe failed with statuscode: 503\n  Warning  Unhealthy  10m (x2 over 10m)  kubelet            Liveness probe failed: HTTP probe failed with statuscode: 503\n'})}),"\n",(0,s.jsx)(n.p,{children:"Now let's check the browser output again."}),"\n",(0,s.jsx)(n.h4,{id:"browser-output-2",children:"Browser Output"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"alt text",src:t(3768).A+"",width:"978",height:"445"})}),"\n",(0,s.jsx)(n.h2,{id:"bonus-points",children:"Bonus Points"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Identify the reasons behind the failure of the Liveness and Readiness probes in the pod."}),"\n",(0,s.jsx)(n.li,{children:"Identify a method to access the application's /healthz endpoint."}),"\n",(0,s.jsx)(n.li,{children:"Attempt to resolve the issues."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},3768:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/probes-1-688cdfc3a87c1bb430237b32d8b24321.png"},9093:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/unavailable-34b078ae4b700c2f365bcd80e3ea26a7.png"},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var s=t(6540);const r={},i=s.createContext(r);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);